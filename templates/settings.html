<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Settings</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex flex-col">
<!-- Top Navigation Bar -->
<header class="w-full bg-gray-800 px-6 py-4 shadow-md">
  <div class="max-w-screen-2xl mx-auto flex justify-between items-center">
    <div class="text-xl font-semibold text-white">Service Tracker</div>
    <div class="flex gap-2">
      <a href="/" class="text-sm px-3 py-1 rounded bg-gray-700 text-gray-200 hover:bg-gray-600">Full</a>
      <a href="/tiled_dash" class="text-sm px-3 py-1 rounded bg-gray-700 text-gray-200 hover:bg-gray-600">Tile</a>
      <a href="/compact_dash" class="text-sm px-3 py-1 rounded bg-gray-700 text-gray-200 hover:bg-gray-600">Compact</a>
      <a href="/add" class="text-sm px-3 py-1 rounded bg-gray-700 text-gray-200 hover:bg-gray-600">Add</a>
      <a href="/settings" class="text-sm px-3 py-1 rounded bg-gray-700 text-gray-200 hover:bg-gray-600">Settings</a>
    </div>
  </div>
</header>
<main class="flex flex-1 px-6 py-6 max-w-screen-2xl mx-auto w-full gap-8">
  
  <!-- === Sidebar Navigation === -->
  <aside class="w-64 bg-gray-800 p-6 space-y-4 border-r border-gray-700">
    <h2 class="text-xl font-semibold mb-4">Settings</h2>
    <!-- Nav: Info -->
    <button onclick="showSection('info')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-700" id="nav-info">
      Info
    </button>
    <!-- Nav: Backup -->
    <button onclick="showSection('backup')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-700" id="nav-backup">
      Backup
    </button>
    <!-- Nav: Widgets -->
    <button onclick="showSection('widgets')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-700" id="nav-widgets">
      Widgets
    </button>
    <!-- Nav: Groups -->
    <button onclick="showSection('groups')" class="w-full text-left px-4 py-2 rounded hover:bg-gray-700" id="nav-groups">
      Groups
    </button>
  </aside>

  <!-- === Main Content Area === -->

  <div class="flex-1 p-8 space-y-10">

    <!-- === Show messages === -->
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div id="flash-container" class="space-y-2 mb-6">
            {% for category, message in messages %}
              <div class="flash-alert flex items-center justify-between text-sm px-4 py-2 rounded shadow bg-green-600 text-white">
                <div class="flex items-center gap-2">
                  
                  <span>{{ message }}</span>
                </div>
                <button class="text-white hover:text-gray-300" onclick="this.parentElement.remove()">×</button>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endwith %}

    <!-- === Info Section === -->
    <section id="section-info" class="section">
      <h2 class="text-2xl font-semibold mb-4">Service Info</h2>
      <div class="mb-4 p-4 bg-gray-700 rounded shadow">
        <h3 class="text-lg font-semibold text-white mb-2">Version Info</h3>
        <ul class="list-disc list-inside text-gray-300 space-y-1">
          <li><strong>Version:</strong> {{ version_info.version | default('unknown') }}</li>
          <li><strong>Commit:</strong> {{ version_info.commit | default('unknown') }}</li>
          <li><strong>Build Time:</strong> {{ version_info.build_time | default('unknown') }}</li>
        </ul>
      </div>
      <h3 class="text-lg font-semibold text-white mt-6 mb-2">Current Configuration</h3>
      <table class="w-full table-auto text-sm bg-gray-800 rounded shadow">
        <thead class="bg-gray-700">
          <tr>
            <th class="p-2 text-left">Key</th>
            <th class="p-2 text-left">Value</th>
            <th class="p-2 text-left">Source</th>
          </tr>
        </thead>
        <tbody>
          {% for key, value in current_config.items() %}
          <tr class="border-t border-gray-600">
            <td class="p-2">{{ key }}</td>
            <td class="p-2">
              <code>
                {% if key == 'api_token' %}
                  ••••••••••
                {% else %}
                  {{ value }}
                {% endif %}
              </code>
            </td>
            <td class="p-2">
              {% if key in config_from_env %}
                <span class="text-green-400">ENV</span>
              {% elif key in config_from_file %}
                <span class="text-yellow-400">YAML</span>
              {% else %}
                <span class="text-red-400">Default</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <!-- === Backup Section === -->
    <section id="section-backup" class="section hidden">
            <!-- === Backup Section === -->
      <h2 class="text-2xl font-semibold mb-6">Backup & Restore</h2>

      <div class="space-y-10">

        <!-- Backup Subsection -->
        <div class="bg-gray-800 rounded shadow p-6">
          <h3 class="text-lg font-semibold text-white mb-2 border-b border-gray-600 pb-1">Backup Service Data</h3>
          <p class="text-sm text-gray-400 mb-4">Manage YAML backups of all your service entries.</p>
          <form action="{{ url_for('settings') }}" method="POST" class="space-y-4">
            <input type="hidden" name="action" value="backup">
            <button type="submit" name="backup_operation" value="download_all"
                    class="w-64 text-sm bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-1.5 px-4 rounded-md shadow">
              Download Full Backup (YAML)
            </button>
            <button type="submit" name="backup_operation" value="save_on_server"
                    class="w-64 text-sm bg-teal-600 hover:bg-teal-700 text-white font-semibold py-1.5 px-4 rounded-md shadow">
              Save Full Backup to Server
            </button>
          </form>
        </div>

        <!-- Restore Subsection -->
        <div class="bg-gray-800 rounded shadow p-6">
          <h3 class="text-lg font-semibold text-white mb-2 border-b border-gray-600 pb-1">Restore Service Data</h3>
          <p class="text-sm text-gray-400 mb-4">Restore service entries from a YAML backup file.</p>
          <form action="{{ url_for('settings') }}" method="POST" enctype="multipart/form-data" class="space-y-6">
            <input type="hidden" name="action" value="restore">

            <!-- Restore Source Choice -->
            <div class="space-y-2">
              <span class="block text-sm font-medium text-gray-300">Restore Source:</span>
              <div class="flex items-center">
                <input id="restore_from_server_select" name="restore_source" type="radio" value="server" checked
                      class="h-4 w-4 text-indigo-500 bg-gray-600 border-gray-500 focus:ring-indigo-400"
                      onchange="toggleRestoreSource(this.value)">
                <label for="restore_from_server_select" class="ml-2 text-sm text-gray-300">Select from server backups</label>
              </div>
              <div class="flex items-center">
                <input id="restore_from_upload" name="restore_source" type="radio" value="upload"
                      class="h-4 w-4 text-indigo-500 bg-gray-600 border-gray-500 focus:ring-indigo-400"
                      onchange="toggleRestoreSource(this.value)">
                <label for="restore_from_upload" class="ml-2 text-sm text-gray-300">Upload a custom YAML file</label>
              </div>
            </div>

            <!-- Server File Selector -->
            <div id="server-file-selector-section">
              <label for="server_backup_filename" class="block text-sm font-medium text-gray-300 mt-4 mb-1">Available server backups:</label>
              <select id="server_backup_filename" name="server_backup_filename"
                      class="w-64 text-sm bg-gray-700 text-gray-200 border border-gray-600 rounded-md px-2 py-1">
                {% if server_backup_files %}
                  {% for filename in server_backup_files %}
                    <option value="{{ filename }}">{{ filename }}</option>
                  {% endfor %}
                {% else %}
                  <option disabled>No backup files found on server</option>
                {% endif %}
              </select>
            </div>

            <!-- File Upload -->
            <div id="file-upload-section" class="hidden">
              <label for="restore_file_input" class="block text-sm font-medium text-gray-300">Upload YAML file:</label>
              <div class="mt-1 flex justify-center items-center px-6 pt-5 pb-6 border-2 border-dashed border-gray-500 rounded-md">
                <div class="text-center space-y-1">
                  <svg class="mx-auto h-12 w-12 text-gray-500" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                    <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                          stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                  </svg>
                  <label for="restore_file_input" class="cursor-pointer text-indigo-400 hover:text-indigo-300">
                    <span>Upload a file</span>
                    <input id="restore_file_input" name="restore_file" type="file" class="sr-only" accept=".yaml,.yml">
                  </label>
                  <p class="text-xs text-gray-500" id="file-name-display">YAML up to 10MB</p>
                </div>
              </div>
            </div>

            <!-- Restore Scope -->
            <div>
              <label for="restore_scope" class="block text-sm font-medium text-gray-300 mt-4 mb-1">Restore Scope:</label>
              <select id="restore_scope" name="restore_scope"
                      class="w-64 text-sm bg-gray-700 text-gray-200 border border-gray-600 rounded-md px-2 py-1">
                <option value="all" selected>All Entries</option>
                <option value="static">Static Entries Only</option>
              </select>
            </div>

            <!-- Submit -->
            <button type="submit"
                    class="w-64 text-sm bg-green-600 hover:bg-green-700 text-white font-semibold py-1.5 px-4 rounded-md shadow">
              Restore Data
            </button>
          </form>
        </div>

      </div>

    </section>

    <!-- === Widgets Section === -->
    <section id="section-widgets" class="section hidden">

      <h2 class="text-2xl font-semibold mb-6">Widgets</h2>
      {% if widgets %}
        <div class="grid gap-6 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3">
          {% for widget in widgets %}
            <div class="bg-gray-800 p-4 rounded-lg shadow">
              <h3 class="text-lg font-semibold text-white mb-2">{{ widget.widget_name }}</h3>
              
              <p class="text-sm text-gray-400 mb-1">
                <strong class="text-gray-300">API URL:</strong><br>
                <code class="break-all">{{ widget.widget_url }}</code>
              </p>

              <p class="text-sm text-gray-400 mb-1">
                <strong class="text-gray-300">API Key:</strong>
                <div class="flex items-center gap-2 mt-1">
                  <input type="password" readonly class="bg-gray-700 text-white text-xs rounded px-2 py-1 w-full truncate" value="{{ widget.widget_api_key }}" id="apikey-{{ widget.id }}">
                  <button class="bg-gray-600 hover:bg-gray-500 text-xs text-white px-2 py-1 rounded" onclick="copyToClipboard('apikey-{{ widget.id }}')">Copy</button>
                </div>
              </p>

              <p class="text-sm text-gray-400 mb-1">
                <strong class="text-gray-300">Fields:</strong>
                <code>{{ widget.widget_fields | join(', ') }}</code>
              </p>

              <p class="text-sm text-gray-400 mb-1">
                <strong class="text-gray-300">Last Update:</strong>
                {% set last_value = widget.widget_values|sort(attribute='last_updated')|last %}
                {{ last_value.last_updated.strftime('%Y-%m-%d %H:%M:%S') if last_value else '—' }}
              </p>

              <p class="text-sm text-gray-400">
                <strong class="text-gray-300">Connected Container:</strong><br>
                {% if widget.services and widget.services[0] %}
                  {{ widget.services[0].container_name }} ({{ widget.services[0].host }})
                {% else %}
                  —
                {% endif %}
              </p>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-gray-400">No widgets found in the database.</p>
      {% endif %}



    </section>

    <!-- === Groups Section === -->
    <section id="section-groups" class="section hidden">
      <h2 class="text-2xl font-semibold mb-4">Groups</h2>
      <p class="text-gray-400">Coming Soon</p>
    </section>
<!-- Your settings content goes here -->
  </div>
  </main>

<script>
  function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
    document.getElementById(`section-${id}`).classList.remove('hidden');

    document.querySelectorAll('aside button').forEach(btn => btn.classList.remove('bg-gray-700', 'text-white'));
    const activeBtn = document.getElementById(`nav-${id}`);
    if (activeBtn) activeBtn.classList.add('bg-gray-700', 'text-white');
  }

  document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const section = urlParams.get('section') || 'info';
    showSection(section);
  });
</script>
<script>
function copyToClipboard(inputId) {
  const input = document.getElementById(inputId);
  if (input) {
    navigator.clipboard.writeText(input.value)
      .then(() => {
        input.classList.add('ring-2', 'ring-green-400');
        setTimeout(() => input.classList.remove('ring-2', 'ring-green-400'), 1000);
      })
      .catch(err => console.error('Copy failed:', err));
  }
}
</script>


</body>
</html>
